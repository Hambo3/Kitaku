var rf = (function(){
  return window.requestAnimationFrame       ||
      window.webkitRequestAnimationFrame ||
      window.mozRequestAnimationFrame    ||
      window.oRequestAnimationFrame      ||
      window.msRequestAnimationFrame     ||
      function(cb){
          window.setTimeout(cb, 1000 / 60);
      };
})();

var lastTime;
var now;
var dt = 0;
var fps = 60;
var step = 1 / fps;

var gameAsset;
var Renderer;

var level = 0;
var plyrScore = 0;
var highScore = 0;
var souls=0;
//dood color pallete
var dCols = [
	['#E7463B','#F2E63C','#AF110E','#C4BA31'],
	['#BF6DAD','#A53720','#BF5698','#7F1E0B'],
	['#69b9c8','#855120','#2b8596','#784614']
];

//pre rendered score images based on routing by https://xem.github.io/miniPixelArt/
var scrs = Util.ImgTxtArr(["@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@I@@@@@@@@@@I@@@@@@@@@@I@I@@@@@@@@I@II@@@@@@@I@III@@@@@@I@I@I@@@@@@I@I@I@I@@@@I@I@I@II@@@I@I@I@III@@I@I@I@I@I@@@@I@I@I@I@@@@III@I@I@@@@@II@I@I@@@@@@I@I@I@@@@@@@@I@I@@@@@@@@III@@@@@@@@@II@@@@@@@@@@I",
"@@@@@@@@@@@@@@@@@@@@@@I@@@@@@@@@@II@@@@@@@@@@II@@@@@@@@@@I@@@@@@@@I@I@I@@@@@@III@II@@@@@III@III@@@@I@I@I@I@@@@I@@@I@I@I@@II@@I@I@II@@II@I@I@III@@I@I@I@I@I@@@@I@I@I@I@@@@III@I@I@@@@@II@I@I@@@@@@I@I@I@@@@@@@@I@I@@@@@@@@III@@@@@@@@@II@@@@@@@@@@I",
"@@@@@@@@@@@@@@@@@@@@@@I@@@@@@@@@@II@@@@@@@@@@II@@@@@@@@@@I@@@@@@@@I@I@I@@@@@@III@II@@@@@@II@III@@@@@@I@I@I@@@@I@I@I@I@I@@III@I@I@II@@II@I@I@III@@I@I@I@I@I@@@@I@I@I@I@@@@III@I@I@@@@@II@I@I@@@@@@I@I@I@@@@@@@@I@I@@@@@@@@III@@@@@@@@@II@@@@@@@@@@I",
"@@@@@@@@@@@@@@@@@@@@@@I@@@@@@@@@@I@@@@@@@@@@I@I@@@@@@@@I@I@@@@@@@@I@I@I@@@@@@III@II@@@@@@II@III@@@@@@I@I@I@@@@@@I@I@I@I@@@@I@I@I@II@@@I@I@I@III@@I@I@I@I@I@@@@I@I@I@I@@@@III@I@I@@@@@II@I@I@@@@@@I@I@I@@@@@@@@I@I@@@@@@@@III@@@@@@@@@II@@@@@@@@@@I"
]);

//return home image
var go = Util.ImgTxtArr(["@@@@@@@@@@@@@@@@@@@@@@@@@@@@@I@@@@@@@@@@@@@HA@@@@@@@@@@@@@I@I@@@@@@@@@@@HAHAI@@@@@@@@@@IAIHIA@@@@@@@@HIIAIII@@@@@@@@IIIHAHAIA@@@@@HAIAI@IHIIA@@@@I@IHAHAIIII@@@HAHAI@IHAIIAI@@@@IHAHAIHAIHIA@@HAI@IHAIHAIII@@@HIIAIHAIHAHA@@@@IIHAIHAI@@@@@@@HAIHAIHIA@@@@@@@HAIHAIII@@@@@@@@HAIHAHA@@@@@@@@@HAI@@@@@@@@@@@@@HIA@@@@@@@@@@@@@II@@@@@@@@@@@@@HA@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@",
"@@@@@@@@@@@@@@@@@@@@@@@@@@@@@I@@@@@@@@@@@@@HA@@@@@@@@@@@@@I@I@@@@@@@@@@@HAHAI@@@@@@@@@@IAIHIA@@@@@@@@HIIAIII@@@@@@@@IIIHAHAI@@@@@@HAIAI@@HA@@@@@@I@IHIA@I@@@@@@HAHAIIIHA@@@@@@@@IHAHAI@@HA@@@@HAI@@HA@@II@@@@@HIA@I@@HIIA@@@@@IIHA@@IHI@@@@@@HAI@@HAHA@@@@@@@HIA@IAI@@@@@@@@@IIHIIA@@@@@@@@@HAIHI@@@@@@@@@@@HA@@@@@@@@@@@@@I@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@"
]);


//map definition and levels
var map = {
	size:{
		tile:{width:32, height:32},
		iso:{width:33, height:33},
		screen:{width:25, height:19}			
	},
	colliders:{hit:[7,8,9],			//things you bump into
		over:[10,11,12,13,14,15],	//things that kill you
		home:[5,6],					//home base
		fend:[16]					//something that ends a moving feature (car/log etc)
	},
	levels:[
		{
			dim:{width:50, height:50},data:"0,31|16|4|0,17|1,31|4,2|1,17|0,31|4,2|0,17|1,31|4,2|1,17|0,31|4,2|0,17|1,6|8,25|9,2|8,11|1,6|0,6|7|0,24|4,2|0,10|7|0,6|1,6|8|1,24|4,2|1,10|8|1,6|0,6|7|0,24|4,2|0,10|7|0,6|1,6|8|1,10|11|1,13|4,2|1,10|8|1,6|0,6|7|0,2|11|0,2|11|0,18|4,2|0,10|7|0,6|1,6|8|1,7|11|12|1,3|11|12,4|1,7|4,2|1,10|8|1,6|0,6|7|0|11|0|11|0,3|10|11|12|0,2|10|11|0,10|4,2|0,10|7|0,6|1,6|8|1,5|11|1|10,2|11|1,2|10|0|1,5|14|15,2|1,2|4,2|1,10|8|1,6|0,6|7|0,4|11|0,6|11|0,7|13|14|15,2|0|4,2|0,10|7|0,6|1,6|8|1,6|11|1,2|11|1,4|11|1,4|13,2|14|15|1|4,2|1,10|8|1,6|0,6|7|0,14|10|0,6|14|0,2|4,2|0,10|7|0,6|1,6|8|1,14|10|1,9|4,2|1,10|8|1,6|0,6|7|0,6|11|12,2|0,15|4,2|0,10|7|0,6|1,6|8|1,17|11|12,2|1,4|4,2|1,10|8|1,6|0,6|7|0,17|10|11|12|0,4|4,2|0,10|7|0,6|1,6|8|1,9|14|15,4|1,3|10,2|11|1,4|4,2|1,10|8|1,6|0,6|7|0,9|13|14|15,4|0,9|4,2|0,10|7|0,6|1,6|8|1,24|4,2|1,10|8|1,6|0,6|7|0,24|4,2|0,10|7|0,6|1,6|8|1,24|4,2|1,10|8|1,6|0,6|7|0,24|4,2|0,10|7|0,6|1,6|8|1,24|4,2|1,10|8|1,6|0,6|7|0,24|4,2|0,10|7|0,6|1,6|8|1,24|4,2|1,10|8|1,6|0,6|7|0,24|4,2|0,10|7|0,6|1,6|8|1,24|4,2|1,10|8|1,6|0,6|7|0,6|5,6|3|0,11|4,2|0,10|7|0,6|1,6|8|1,6|5,6|3,9|2,2|3|4,2|1,10|8|1,6|0,6|7|0,6|5,6|3,8|2,2|3|2|4,2|0,10|7|0,6|1,6|8|1,6|5,6|3|1,9|2|1|4,2|1,10|8|1,6|0,6|7|0,6|5,6|0,12|4,2|0,10|7|0,6|1,6|8|1,24|4,2|1,10|8|1,6|0,6|7|0,24|4,2|0,10|7|0,6|1,6|8|1,24|4,2|1,10|8|1,6|0,6|7|0,24|4,2|0,10|7|0,6|1,6|8|1,24|4,2|1,10|8|1,6|0,6|7|0,24|4,2|0,10|7|0,6|1,6|8,25|9,2|8,11|1,6|0,31|4,2|0,17|1,31|4,2|1,17|0,31|4,2|0,17|1,31|4,2|1,17|0,31|4,2|0,17|1,31|4|16|1,17",
			st:48,									//random features number of
			features:{	plyrspawn:  {x:16,y:34},	//player start point
						doodspawn:[					//doods spawn point
							{x:22,y:9,t:0},
							{x:38,y:31,t:1}
							],
						carhl:[],					//car left spawn point
						carhr:[],					//car right spawn point
						carvu:[ {x:31,y:49} ],		//car up spawn point
						carvd:[ {x:32,y:0} ],		//car down spawn point
						boat:[],					//log spawn point
						hard:[						//locations of trees etc
							{x:11,y:8},
							{x:14,y:8},
							{x:9,y:14},
							{x:9,y:15},
							{x:10,y:16},
							{x:26,y:16},
							{x:27,y:16},
							{x:18,y:17},
							{x:19,y:18},
							{x:30,y:18},
							{x:17,y:19},
							{x:27,y:19},
							{x:28,y:19},
							{x:29,y:19},
							{x:27,y:20}							
						]
					}
		},
		{
			dim:{width:60, height:60},data:"15,27|0,17|16|4|0,14|15,27|1,17|4,2|1,14|15,16|16|15,9|0,18|4,2|0,14|15,25|1,19|4,2|1,14|15,26|0,18|4,2|0,14|15,26|8,18|9,2|8,8|1,6|15,27|0,17|4,2|0,7|7|0,6|1,2|14|15,10|3,3|14|1,5|14|15,4|1,17|4,2|1,7|8|1,6|0,6|7|2,8|0|13|0,6|14|15,3|0,17|4,2|0,7|7|0,6|1,6|8|1,9|13|1,23|11|1,3|4,2|1,7|8|1,6|0,6|7|0,9|13|0,23|10|0,3|4,2|0,7|7|0,6|1,6|8|1,9|13|1,9|11|12|1,4|11|1,11|4,2|1,7|8|1,6|0,6|7|0,9|13|0,9|10|0,17|4,2|0,7|7|0,6|1,6|8|1,9|13|1,11|11|12|1|11|1,2|11|1,4|11|1,4|4,2|1,7|8|1,6|0,6|7|0,9|13|0,19|11|0,7|4,2|0,7|7|0,6|1,6|8|1,9|13|1,15|11|12|1,4|11|1,5|4,2|1,7|8|1,6|0,6|7|0,9|13|0,15|10|0,11|4,2|0,7|7|0,6|1,6|8|1,9|13|1,27|4,2|1,7|8|1,6|0,6|7|0,9|13|0,27|4,2|0,7|7|0,6|1,6|8|1,9|13|1,11|11|1,15|4,2|1,7|8|1,6|0,6|7|0,6|14|15,2|13|0,13|11|12|0,12|4,2|0,7|7|0,6|1,6|8|1,4|14|15|13|1,16|10|11|1,12|4,2|1,7|8|1,6|0,6|7|0,4|13|14|0,20|11|12,2|0,8|4,2|0,7|7|0,6|1,6|8|1,4|13,2|1,20|10|1,10|4,2|1,7|8|1,6|0,6|7|0,4|13,2|0,31|4,2|0,7|7|0,6|1,6|8|1,17|11|12|1,18|4,2|1,7|8|1,6|0,6|7|0,17|10|11|0,18|4,2|0,7|7|0,6|4,6|9|4,46|9|4,5|16,2|4,5|9|4,46|9|4,6|0,6|7|0,37|4,2|0,7|7|0,6|1,6|8|1,20|11|12|1,15|4,2|1,7|8|1,6|0,6|7|0,20|10|11|0|14|15,3|0,10|4,2|0,7|7|0,6|1,6|8|1,23|13|14|15,3|1,9|4,2|1,7|8|1,6|0,6|7|0,22|2|13,2|14|15,2|2|0,8|4,2|0,7|7|0,6|1,6|8|1,23|3|2|3|2|3,2|1,8|4,2|1,7|8|1,6|0,6|7|0,24|3|2|3|0,10|4,2|0,7|7|0,6|1,6|8|1,18|5,5|1,2|3,2|1,10|4,2|1,7|8|1,6|0,6|7|0,18|5,5|3,7|2|0|2|0,4|4,2|0,7|7|0,6|1,6|8|1,18|5,5|3,6|2|3|2|1,5|4,2|1,7|8|1,6|0,6|7|0,18|5,5|0,14|4,2|0,7|7|0,6|1,6|8|1,37|4,2|1,7|8|1,6|0,6|7|0,37|4,2|0,7|7|0,6|1,6|8|1,37|4,2|1,7|8|1,6|0,6|7|0,37|4,2|0,7|7|0,6|1,6|8|1,37|4,2|1,7|8|1,6|0,6|7|0,37|4,2|0,7|7|0,6|4,6|9|4,46|9|4,5|16|0,6|7|0,46|7|0,6|16|4,5|9|4,46|9|4,6|0,6|7|0,37|4,2|0,7|7|0,6|1,6|8|1,37|4,2|1,7|8|1,6|0,6|7|0,37|4,2|0,7|7|0,6|1,6|8|1,37|4,2|1,7|8|1,6|0,6|7,38|9,2|7,8|0,6|1,44|4,2|1,14|0,44|4,2|0,14|1,44|4,2|1,14|0,44|4,2|0,14|1,44|4,2|1,14|0,44|4|16|0,14",
			st:80,
			features:{
				plyrspawn:{x:27,y:38},
				doodspawn:[
					{x:36,y:11,t:0},
					{x:11,y:12,t:0},
					{x:49,y:39,t:1},
					{x:20,y:52,t:2}
				],
				carhl:[
					{x:59,y:28},
					{x:59,y:48}
				],
				carhr:[
					{x:0,y:27},
					{x:0,y:46}
				],
				carvu:[
					{x:44,y:59}
				],
				carvd:[
					{x:45,y:0}
				],
				hard:[
					{x:17,y:16},
					{x:17,y:17},
					{x:18,y:17},
					{x:17,y:18},
					{x:18,y:18},
					{x:17,y:19},
					{x:17,y:20},
					{x:14,y:21},
					{x:15,y:21},
					{x:16,y:21},
					{x:13,y:22},
					{x:15,y:22},
					{x:7,y:23},
					{x:13,y:23},
					{x:16,y:23},
					{x:8,y:24},
					{x:9,y:25},
					{x:10,y:25},
					{x:11,y:25},
					{x:12,y:25},
					{x:12,y:26},
					{x:30,y:36},
					{x:32,y:36},
					{x:34,y:36},
					{x:30,y:39},
					{x:32,y:39},
					{x:34,y:40}
				],
				boat:[{x:16,y:18}]
				}
		}
	]
};


/*****************************/
var ctx;
function Start(canvasBody)
{	
	// Create the canvas
	var canvas = document.createElement("canvas");
	if(canvas.getContext)
	{
		ctx = canvas.getContext("2d");
		canvas.width = (map.size.screen.width * map.size.tile.width);
		canvas.height = (map.size.screen.height * map.size.tile.height);

		var b = document.getElementById(canvasBody);
    	b.appendChild(canvas);

		//everything is drawn by this renderer
		Renderer = new Rendering(ctx, {w:canvas.width, h:canvas.height}, 
			{x1:32,x2:32, y1:32,y2:96});

		init();
	}
}

function init()
{  
  var now = timestamp();	
	lastTime = now;
	
	gameAsset = new Title(map.size, GameStart, 0);
	FixedLoop();  
}

function GameStart(lv){
	if(lv==0){
		plyrScore=0;
		souls=0;
	}
	level = (lv==null) ? level : lv;
	gameAsset = new Game(map, TitleScreen, level);
}

function TitleScreen(alive, lost){
	souls+=lost;
	level = (alive) ? level+1 : 0;
	gameAsset = new Title(map.size, GameStart, level, !alive, souls);

}

function FixedLoop(){
	now = timestamp();
	dt = dt + Math.min(1, (now - lastTime) / 1000);
	while (dt > step) {
	  dt = dt - step;
	  update(step);
	}

	render();
				
	lastTime = now;
	rf(FixedLoop);
}

function timestamp() {
	var wp = window.performance;
	return wp && wp.now ? wp.now() : new Date().getTime();
}

// Update game objects
function update(dt) {
	gameAsset.Update(dt);
};

function render() {
	gameAsset.Render();
};

window.onload = function() {
	Start("canvasBody");
}
